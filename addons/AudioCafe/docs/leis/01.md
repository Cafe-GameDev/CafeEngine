# Projeto de Lei 01: A Evolução do AudioCafe para Godot 4.3+

**Autor:** Gemini, a serviço do CafeEngine
**Data:** 10 de Setembro de 2025
**Status:** Proposto

---

### **Preâmbulo**

Considerando as significativas e bem-vindas evoluções no subsistema de áudio do Godot Engine, introduzidas a partir da versão 4.3; 

Reconhecendo que os recursos nativos `AudioStreamPlaylist` e `AudioStreamInteractive` oferecem soluções robustas e eficientes para desafios que o `AudioCafe` v1 buscava resolver de forma customizada;

E com o objetivo de manter a relevância, utilidade e superioridade do plugin como uma ferramenta indispensável para desenvolvedores Godot;

Fica estabelecido este Projeto de Lei para a completa refatoração e evolução do `AudioCafe`, que passará a ser conhecido como **AudioCafe v2.0**.

---

### **Artigo I: Visão e Princípios Fundamentais**

**Seção 1.1: Nova Declaração de Propósito**
O `AudioCafe` v2.0 é redefinido não como um substituto, mas como uma **Camada de Gerenciamento e Aceleração de Fluxo de Trabalho (Workflow and Management Layer)** sobre o sistema de áudio nativo do Godot. Sua missão é tornar o uso dos recursos de áudio da engine mais rápido, mais organizado e mais escalável.

**Seção 1.2: Princípio da Integração Nativa**
A nova arquitetura do plugin irá **abraçar e estender** os recursos nativos. As implementações customizadas de playlists e máquinas de estado de áudio serão descontinuadas em favor do uso direto de `AudioStreamPlaylist` e `AudioStreamInteractive` como base de reprodução.

---

### **Artigo II: Refatoração da Arquitetura Central**

**Seção 2.1: O `CafeAudioManager`**
O `CafeAudioManager` será refatorado para atuar como um dispatcher de alto nível e um gerenciador de recursos.
- **Diretriz 2.1.1:** A lógica interna de seleção aleatória de músicas será removida. O sinal `play_music_requested("chave_playlist")` irá agora procurar no `AudioManifest` por um recurso `AudioStreamPlaylist` correspondente à chave e o atribuirá a um `AudioStreamPlayer` gerenciado.
- **Diretriz 2.1.2:** O sistema de pooling de `AudioStreamPlayer`s para SFX será mantido e otimizado, pois continua a oferecer vantagens de performance em cenários de uso intenso.

**Seção 2.2: O `AudioPosition` (2D/3D)**
Este nó será transformado para se tornar um controlador para o `AudioStreamInteractive`.
- **Diretriz 2.2.1:** A propriedade `state_audio: Dictionary` será marcada como `[deprecated]` e, eventualmente, removida.
- **Diretriz 2.2.2:** Uma nova propriedade, `@export var interactive_stream: AudioStreamInteractive`, será adicionada e se tornará o principal ponto de configuração.
- **Diretriz 2.2.3:** A função `set_state(state_key)` será substituída por `travel(transition_name: String)`. Esta nova função irá obter o `AudioStreamPlaybackInteractive` do player e chamar sua função nativa `travel(transition_name)`, delegando todo o controle da lógica de transição para a engine.

**Seção 2.3: O `AudioManifest`**
O manifesto evoluirá para se tornar um catálogo de recursos de áudio, não apenas de arquivos.
- **Diretriz 2.3.1:** A estrutura de dados do `AudioManifest` será atualizada para que suas chaves (`sfx_data`, `music_data`) mapeiem para UIDs de recursos `.tres` (`AudioStreamPlaylist`, `AudioStreamInteractive`) ou para UIDs de arquivos `.ogg`/`.wav` para SFX simples.
- **Diretriz 2.3.2:** O script de geração (`generate_audio_manifest.gd`) será reescrito para escanear os diretórios de projeto, identificar os diferentes tipos de ativos de áudio (arquivos e recursos) e populá-los corretamente no manifesto sob novas categorias, se necessário (e.g., `interactive_data`, `playlist_data`).

---

### **Artigo III: Evolução das Ferramentas de Editor (`AudioPanel`)**

O `AudioPanel` será o centro do novo workflow, focado na criação e gerenciamento dos recursos de áudio.

- **Seção 3.1: Gerenciamento de Recursos de Áudio**
    - **Diretriz 3.1.1:** O painel incluirá botões como "New Interactive Audio" e "New Audio Playlist". Ao serem clicados, eles abrirão uma janela para o usuário nomear e salvar um novo arquivo `.tres` do tipo correspondente.
    - **Diretriz 3.1.2:** Após a criação, o painel poderá oferecer um atalho para abrir o recurso recém-criado no inspetor ou no editor de áudio interativo nativo do Godot.

- **Seção 3.2: Geração de Manifesto Aprimorada**
    - **Diretriz 3.2.1:** O botão "Generate Audio Manifest" acionará o novo script de geração, que é ciente dos diferentes tipos de recursos e os catalogará corretamente.
    - **Diretriz 3.2.2:** As abas "Music List" e "SFX List" serão reformuladas para "Audio Keys" e exibirão as chaves para todos os tipos de áudio gerenciados (SFX, Playlists, Interactive), talvez com ícones para diferenciá-los.

---

### **Artigo IV: Novas Funcionalidades e Melhorias de QoL (Qualidade de Vida)**

**Seção 4.1: Controle de Reprodução Avançado**
- **Diretriz 4.1.1 (Seleção por Índice):** A função `play_sfx_requested` será estendida para aceitar um parâmetro de índice opcional: `play_sfx_requested(key: String, bus: String, node: Node, index: int = -1)`. Se o índice for -1, o comportamento aleatório padrão é mantido. Caso contrário, o som específico naquele índice da lista do manifesto será reproduzido.

**Seção 4.2: Sistema de Oclusão de Áudio (Experimental)**
- **Diretriz 4.2.1:** O nó `AudioPosition` terá uma propriedade booleana `enable_occlusion`. Se `true`, o nó realizará um `raycast` para o `listener` da cena a cada `_physics_process`.
- **Diretriz 4.2.2:** Se o `raycast` for obstruído por um `PhysicsBody`, um filtro `low-pass` será aplicado dinamicamente ao bus do `AudioStreamPlayer` ou diretamente ao player, se possível, para simular o abafamento do som. A intensidade do filtro pode ser configurável.

---

### **Artigo V: Plano de Transição e Comunicação**

**Seção 5.1: Versionamento**
Esta grande refatoração marcará o lançamento do **AudioCafe 2.0**. A versão será claramente comunicada para evitar confusão.

**Seção 5.2: Documentação**
Toda a documentação em `docs/` será revisada e reescrita para refletir a nova arquitetura, com tutoriais focados no novo workflow de gerenciamento de recursos nativos.

**Seção 5.3: Guia de Migração**
Um novo arquivo, `docs/MigrationFromV1.md`, será criado. Ele fornecerá um guia passo a passo para os usuários da v1, explicando como:
1. Converter a lógica de `AudioPosition` para `AudioStreamInteractive`.
2. Reorganizar os ativos de música para usar `AudioStreamPlaylist`.
3. Regenerar o `AudioManifest` com o novo sistema.

---

### **Conclusão**

Este Projeto de Lei estabelece um caminho claro para a evolução do `AudioCafe`. Ao abraçar as ferramentas nativas da Godot e focar em um workflow de alta qualidade, o `AudioCafe` não apenas garante sua relevância contínua, mas se posiciona para ser um companheiro ainda mais poderoso e indispensável para o desenvolvimento de áudio no Godot Engine. A implementação destes mandatos começará imediatamente após a aprovação.
